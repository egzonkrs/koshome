@startuml
title Token Refresh Flow

actor "User" as user
boundary "Next.js Frontend" as frontend
boundary "API Controller" as controller
control "MediatR" as mediator
control "RefreshTokenCommandHandler" as handler
boundary "Keycloak" as keycloak

user -> frontend: Perform action with expired access token
frontend -> frontend: Detect Expired Token
frontend -> controller: POST /api/v1/auth/refresh
note right: Sends refresh token in request

controller -> mediator: Send(RefreshTokenCommand)
mediator -> handler: Handle(RefreshTokenCommand)

handler -> keycloak: Request New Tokens using Refresh Token
keycloak --> handler: Return New Token Pair or Error

alt Refresh Success
    handler --> mediator: Return Result.Success(TokenResponse)
    mediator --> controller: Return Success Result
    controller --> frontend: 200 OK with New Tokens
    frontend -> frontend: Update Stored Tokens
    frontend -> frontend: Retry Original Request
    frontend --> user: Continue Original Action
else Refresh Failure (Invalid/Expired Refresh Token)
    handler --> mediator: Return Result.Fail()
    mediator --> controller: Return Error Result
    controller --> frontend: 401 Unauthorized
    frontend -> frontend: Clear Token Storage
    frontend --> user: Redirect to Login
end

@enduml 