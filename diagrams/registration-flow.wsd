@startuml
title User Registration Flow

actor "User" as user
boundary "Next.js Frontend" as frontend
boundary "API Controller" as controller
control "MediatR" as mediator
control "RegisterUserCommandHandler" as handler
entity "UserRepository" as repo
database "Database" as db
boundary "Keycloak" as keycloak

user -> frontend: Fill registration form
frontend -> frontend: Validate form (Zod)
frontend -> controller: POST /api/v1/accounts/register
controller -> mediator: Send(RegisterUserCommand)
mediator -> handler: Handle(RegisterUserCommand)

handler -> handler: Validate request (FluentValidation)
handler -> keycloak: Create User Account
keycloak --> handler: Return Success/Failure
alt Success
    handler -> repo: Create Local User Profile
    repo -> db: Save User
    db --> repo: Success
    repo --> handler: Return Success
    handler --> mediator: Return Result.Success()
    mediator --> controller: Return Success Result
    controller --> frontend: 201 Created with Account Details
    frontend --> user: Show Success & Redirect to Login
else Failure (Validation Error or Keycloak Error)
    handler --> mediator: Return Result.Fail()
    mediator --> controller: Return Error Result
    controller --> frontend: 400 Bad Request with Error Details
    frontend --> user: Show Error Message
end

@enduml 